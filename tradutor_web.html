<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      padding: 20px;
      margin: 0;
      background: #f9fafc;
      color: #111;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      max-width: 600px;
      margin: 0 auto;
    }
    h1 {
      font-size: 1.3rem;
      margin-bottom: 0.75rem;
      text-align: center;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      resize: vertical;
      padding: 10px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
    }
    button.primary {
      background: #0077cc;
      color: #fff;
      width: 100%;
    }
    #status {
      font-size: 13px;
      text-align: center;
      color: #555;
      margin-top: 8px;
    }
    #avatar-container {
      width: 100%;
      height: 320px;
      margin-top: 20px;
      border-radius: 12px;
      overflow: hidden;
      background: #f0f0f0;
      position: relative;
    }
    [vw-access-button],
    .vw-plugin-top-wrapper {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Tradutor VLibras</h1>
    <button id="btnTranslate" class="primary">Traduzir para Libras</button>
    <div id="status">Carregando VLibras...</div>

    <!-- container onde o modelo 3D será embutido -->
    <div id="avatar-container"></div>
  </div>

  <!-- container padrão do VLibras -->
  <div vw class="enabled">
    <div vw-access-button></div>
    <div vw-plugin-wrapper>
      <div class="vw-plugin-top-wrapper"></div>
    </div>
  </div>

  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>

  <script>
    // Inicializa VLibras e move o avatar 3D para dentro do container customizado
    function initVLibrasInline() {
      new window.VLibras.Widget('https://vlibras.gov.br/app');
      const status = document.getElementById('status');
      status.innerText = 'VLibras carregado. Pronto.';

      // aguarda o widget renderizar (leva 1-2 segundos)
      setTimeout(() => {
        // localiza o iframe ou div principal do avatar
        const iframe = document.querySelector('iframe[src*="vlibras.gov.br"]');
        const wrapper = document.querySelector('.vw-plugin-top-wrapper');

        if (iframe || wrapper) {
          const avatarContainer = document.getElementById('avatar-container');
          if (wrapper) {
            avatarContainer.appendChild(wrapper);
          } else {
            avatarContainer.appendChild(iframe);
          }

          // ajusta estilos
          Object.assign(avatarContainer.style, {
            display: 'block',
            height: '320px',
            background: '#000',
          });

          status.innerText = 'Avatar carregado abaixo.';
        } else {
          status.innerText = 'VLibras iniciado, aguardando avatar...';
        }
      }, 2000);
    }

    // inicialização segura
    document.addEventListener('DOMContentLoaded', () => {
      if (window.VLibras && typeof window.VLibras.Widget === 'function') {
        initVLibrasInline();
      } else {
        const int = setInterval(() => {
          if (window.VLibras && typeof window.VLibras.Widget === 'function') {
            clearInterval(int);
            initVLibrasInline();
          }
        }, 500);
      }

      // Ação de tradução
      document.getElementById('btnTranslate').addEventListener('click', () => {
        const text = document.getElementById('txt').value.trim();
        if (!text) return alert('Digite um texto para traduzir.');
        programmaticSelectAndTrigger(text);
      });
    });

    // Função auxiliar para disparar tradução
    function programmaticSelectAndTrigger(text) {
      let temp = document.getElementById('vlibras-temp');
      if (temp) temp.remove();

      temp = document.createElement('div');
      temp.id = 'vlibras-temp';
      temp.textContent = text;
      temp.style.position = 'fixed';
      temp.style.left = '-9999px';
      document.body.appendChild(temp);

      const range = document.createRange();
      range.selectNodeContents(temp);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);

      document.dispatchEvent(new MouseEvent('mouseup', { bubbles: true }));
      document.dispatchEvent(new Event('selectionchange'));

      document.getElementById('status').innerText =
        'Traduzindo texto... aguarde o avatar abaixo.';
    }
  </script>
</body>
</html>

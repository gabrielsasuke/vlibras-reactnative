<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VLibras Demo — Texto para Libras (3D)</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 24px; background:#f7f7fb; color:#111; }
    .card { background:#fff; border-radius:12px; padding:18px; box-shadow:0 6px 18px rgba(20,20,40,0.06); max-width:820px; margin:16px auto; }
    textarea { width:100%; min-height:140px; resize:vertical; padding:10px; font-size:15px; border-radius:8px; border:1px solid #ddd; }
    .controls { display:flex; gap:10px; margin-top:12px; align-items:center; }
    button { padding:10px 14px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
    button.primary { background:#0066cc; color:#fff; }
    button.ghost { background:#fff; color:#333; border:1px solid #ccc; }
    #status { font-size:13px; color:#555; margin-left:8px; }
    /* o elemento temporário fica fora da tela e invisível */
    #vlibras-temp { position:fixed; left:-9999px; top:-9999px; width:10px; height:10px; overflow:hidden; white-space:pre-wrap; }
  </style>
</head>
<body>
  <div class="card">
    <h1>VLibras — Converter texto para Libras (modelo 3D)</h1>
    <p>Digite o texto abaixo e clique em "<strong>Traduzir para Libras</strong>". O widget do VLibras será ativado e tentará reproduzir o texto com o avatar 3D.</p>

    <textarea id="txt" placeholder="Digite aqui o texto que deseja traduzir para Libras...">Olá! Este é um teste de tradução para Libras usando o widget VLibras.</textarea>

    <div class="controls">
      <button id="btnTranslate" class="primary">Traduzir para Libras</button>
      <button id="btnOpenWidget" class="ghost">Abrir/Fechar Widget</button>
      <div id="status">Carregando VLibras...</div>
    </div>
    <p style="margin-top:12px;color:#666;font-size:13px;">
      Observação: se o avatar não aparecer automaticamente, abra o widget com o botão <em>Abrir/Fechar Widget</em>. Em alguns sites/páginas a detecção de seleção funciona melhor que em outras.
    </p>
  </div>

  <div vw class="enabled">
    <div vw-access-button class="active"></div>
    <div vw-plugin-wrapper>
      <div class="vw-plugin-top-wrapper"></div>
    </div>
  </div>

  <!-- script oficial do VLibras (widget) -->
  <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>

  <script>
    (function initVLibras(){
      try {
        if (window.VLibras && typeof window.VLibras.Widget === 'function') {
          new window.VLibras.Widget('https://vlibras.gov.br/app');
          document.getElementById('status').innerText = 'VLibras carregado. Pronto.';
        } else {
          document.getElementById('status').innerText = 'Aguardando carregamento do plugin...';
          var retries = 0;
          var int = setInterval(function(){
            if (window.VLibras && typeof window.VLibras.Widget === 'function') {
              new window.VLibras.Widget('https://vlibras.gov.br/app');
              document.getElementById('status').innerText = 'VLibras carregado. Pronto.';
              clearInterval(int);
            } else {
              retries++;
              document.getElementById('status').innerText = 'Aguardando plugin... (' + retries + ')';
              if (retries > 20) {
                clearInterval(int);
                document.getElementById('status').innerText = 'Falha ao carregar plugin. Verifique conexão/console.';
              }
            }
          }, 500);
        }
      } catch(e){
        console.error('Erro inicializando VLibras:', e);
        document.getElementById('status').innerText = 'Erro inicializando VLibras (veja console).';
      }
    })();

    function programmaticSelectAndTrigger(text) {
      var old = document.getElementById('vlibras-temp');
      if (old) old.remove();

      var div = document.createElement('div');
      div.id = 'vlibras-temp';
      div.textContent = text || '';
      document.body.appendChild(div);

      // cria range e seleciona o conteúdo do div
      var selection = window.getSelection();
      selection.removeAllRanges();
      var range = document.createRange();
      range.selectNodeContents(div);
      selection.addRange(range);

      var mouseUp = new MouseEvent('mouseup', { bubbles: true, cancelable: true, view: window });
      document.dispatchEvent(mouseUp);
      document.dispatchEvent(new Event('selectionchange'));
      document.getElementById('status').innerText = 'Texto selecionado — o widget deve reproduzir a tradução.';
    }

    document.getElementById('btnTranslate').addEventListener('click', function(){
      var txt = document.getElementById('txt').value.trim();
      if (!txt) {
        alert('Digite algum texto para traduzir.');
        return;
      }
      programmaticSelectAndTrigger(txt);
    });

    // Abre/fecha o widget (tenta clicar no botão de acesso criado pelo plugin)
    document.getElementById('btnOpenWidget').addEventListener('click', function(){
      // o plugin costuma criar um botão com atributo vw-access-button
      var btn = document.querySelector('[vw-access-button]');
      if (btn) {
        try {
          btn.click();
        } catch(e){
          // fallback: se for um elemento interno, podemos tentar simular evento
          var evt = new MouseEvent('click', { bubbles: true, cancelable: true, view: window });
          btn.dispatchEvent(evt);
        }
      } else {
        alert('Botão do widget não encontrado. Aguarde o carregamento do plugin ou verifique o console.');
      }
    });

    document.addEventListener('selectionchange', function(){
      clearTimeout(window.__vlibras_clear_sel);
      window.__vlibras_clear_sel = setTimeout(function(){
        var s = window.getSelection();
        if (s) s.removeAllRanges();
      }, 6000);
    });
  </script>
</body>
</html>
